# Урок 21. Автоматическая корзина для мусора

## Теория

Автоматическая корзина открывает крышку, когда к ней подносят руку или предмет, и закрывает спустя короткую паузу.  
Типовой принцип работы: датчик фиксирует объект на близком расстоянии → Arduino подаёт команду сервоприводу → крышка открывается → по таймеру закрывается.  
В качестве датчика удобно использовать **ультразвуковой HC‑SR04** (или ИК‑датчик приближения), а в качестве привода — **сервопривод** SG90/SG92R/МG90S.

Ключевые моменты:
- **Порог расстояния** (например, 10–20 см) — чтобы корзина не срабатывала «издалека».  
- **Гистерезис и задержка закрытия** — во время выбрасывания мусора крышка не должна «дёргаться».  
- **Безопасность** — сервопривод не должен упираться в механические ограничители.

---

## Интересные факты

- Бесконтактные мусорные ведра стали популярны в медицинских учреждениях для снижения перекрёстного загрязнения.  
- Умные корзины в «зелёных» офисах используют счётчики открытий для оптимизации графика уборки.  
- В промышленных линиях похожая логика применяется для автоматических створок и клапанов.

---

## Практика

### Материалы

- Arduino Uno (или совместимая).  
- Сервопривод (SG90/SG92R/MG90S).  
- Ультразвуковой датчик **HC‑SR04** (или ИК‑датчик расстояния — опционально).  
- Питание 5 В (желательно отдельное для сервопривода, общий GND).  
- Макетная плата, провода, лёгкая крышка/шарнир.

> Рекомендуется питать сервопривод от отдельного 5 В источника (2–3 А) и соединить землю сервопривода и Arduino (общий GND).

### Подключение (HC‑SR04 + серво)

- **HC‑SR04**: VCC → 5V, GND → GND, TRIG → D3, ECHO → D4.  
- **Servo**: сигнал → D9, VCC → 5V (от внешнего БП), GND → общий GND.

---

## Программный код (устойчивое открытие, авто‑закрытие, антидёргание)

```cpp
// Урок 21: Автоматическая корзина для мусора
// Логика: обнаружили объект ближе порога -> открыть на OPEN_MS, затем закрыть.
// Добавлены усреднение расстояния и таймер без delay().

#include <Servo.h>

const int TRIG_PIN = 3;
const int ECHO_PIN = 4;
const int SERVO_PIN = 9;

const int OPEN_ANGLE  = 95;     // подберите под механику крышки
const int CLOSE_ANGLE = 5;      // закрытое положение
const int THRESHOLD_CM = 18;    // порог срабатывания (10–25 см обычно)
const unsigned long HOLD_OPEN_MS = 2500; // сколько держать крышку открытой
const unsigned long SAMPLE_PERIOD_MS = 50; // период измерений

Servo lid;

unsigned long lastSample = 0;
unsigned long openedAt = 0;
bool isOpen = false;

// простое усреднение для устойчивости
long readDistanceCm() {
  long sum = 0;
  const int N = 5;
  for (int i = 0; i < N; i++) {
    // триггер
    digitalWrite(TRIG_PIN, LOW); delayMicroseconds(2);
    digitalWrite(TRIG_PIN, HIGH); delayMicroseconds(10);
    digitalWrite(TRIG_PIN, LOW);
    // измерение
    long duration = pulseIn(ECHO_PIN, HIGH, 30000UL); // тайм‑аут ~30 ms (~5 м)
    long cm = duration > 0 ? (duration * 0.034 / 2.0) : 999;
    sum += cm;
    delay(5);
  }
  return sum / N;
}

void openLid() {
  lid.write(OPEN_ANGLE);
  isOpen = true;
  openedAt = millis();
}

void closeLid() {
  lid.write(CLOSE_ANGLE);
  isOpen = false;
}

void setup() {
  pinMode(TRIG_PIN, OUTPUT);
  pinMode(ECHO_PIN, INPUT);
  lid.attach(SERVO_PIN);
  closeLid();
  Serial.begin(9600);
  Serial.println("Smart Bin ready.");
}

void loop() {
  unsigned long now = millis();

  if (now - lastSample >= SAMPLE_PERIOD_MS) {
    lastSample = now;
    long dist = readDistanceCm();
    Serial.print("dist: "); Serial.println(dist);

    if (!isOpen) {
      // условие открытия
      if (dist > 0 && dist < THRESHOLD_CM) {
        openLid();
      }
    } else {
      // держим открытой фиксированное время от момента открытия
      if (now - openedAt >= HOLD_OPEN_MS) {
        closeLid();
      }
    }
  }
}
```

Вариант без ультразвука (ИК‑датчик приближения)

Если в наборе есть простой ИК‑датчик с цифровым выходом (LOW/HI при присутствии объекта), можно сократить схему: вход Arduino → D2, логика — открыть при обнаружении, закрыть по таймеру.

```cpp
// Корзина с ИК-датчиком (цифровой выход)
#include <Servo.h>

const int IR_PIN = 2;      // цифровой сигнал датчика
const int SERVO_PIN = 9;

const int OPEN_ANGLE  = 95;
const int CLOSE_ANGLE = 5;
const unsigned long HOLD_OPEN_MS = 2500;

Servo lid;
unsigned long openedAt = 0;
bool isOpen = false;

void setup() {
  pinMode(IR_PIN, INPUT); // или INPUT_PULLUP в зависимости от датчика
  lid.attach(SERVO_PIN);
  lid.write(CLOSE_ANGLE);
}

void loop() {
  int seen = digitalRead(IR_PIN); // настройте логику под ваш модуль (0 или 1)
  unsigned long now = millis();

  if (!isOpen && seen == HIGH) {
    lid.write(OPEN_ANGLE);
    isOpen = true;
    openedAt = now;
  }

  if (isOpen && (now - openedAt >= HOLD_OPEN_MS)) {
    lid.write(CLOSE_ANGLE);
    isOpen = false;
  }
}

```

Эксперименты

Подберите порог расстояния (10–25 см) и время удержания крышки (1–5 с) под реальные условия.
Добавьте индикаторный светодиод: мигает, пока крышка открыта.
Реализуйте плавное открытие/закрытие (анимация: шагами менять угол с небольшими задержками).
Введите режим экономии: если в течение N минут не было срабатываний — уводить серво в «снятое питание» (detach) и подключать при первом обнаружении.
Добавьте защиту от дребезга событий: открытие возможно только если подряд получены 2–3 «валидных» измерения ближе порога.

Задание для самостоятельной работы

Нарисуйте схему подключения (HC‑SR04 + серво + раздельное питание сервопривода, общий GND).
Составьте таблицу из 20 измерений: расстояние → решение (открыть/нет) → факт срабатывания.
Реализуйте гистерезис: открывать при < 18 см, но не закрывать, пока не станет > 25 см (уменьшает «дёрганье» в пограничной зоне).
Добавьте кнопку «ручного открытия» крышки и кнопку «блокировки» (на время уборки крышка не реагирует на датчик).
Если есть датчик заполнения (например, второй ультразвук внутри или простая кнопка‑концевик), выводите в Serial или на LED «Корзина заполнена».

Замечания по механике и питанию

Не допускайте, чтобы сервопривод упирался в крышку: задайте углы CLOSE_ANGLE/OPEN_ANGLE так, чтобы не было механической перегрузки.
Крышка должна быть лёгкой и сбалансированной (используйте шарнир/петлю с низким трением).
Питайте серво от отдельного 5 В БП (2–3 А), соедините земли с Arduino.
Разведите провода датчика отдельно от силовых проводов серво, чтобы уменьшить помехи.
